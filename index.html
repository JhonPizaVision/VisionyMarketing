<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visión y Marketing - Documentos de Clientes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="https://www.visionymarketing.com.co/favicon.ico" type="image/x-icon">
  <style>
    body { background-color: #fff9f9; }
    .brand-red { background-color: #c1121f; }
    .brand-hover:hover { transform: translateY(-3px); transition: 0.2s; }
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #c1121f;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="text-gray-800 font-sans flex flex-col min-h-screen">

  <!-- HEADER -->
  <header class="brand-red text-white shadow-md">
    <div class="max-w-6xl mx-auto px-6 py-6 flex flex-col sm:flex-row justify-between items-center">
      <div class="flex items-center space-x-4">
        <img src="https://www.visionymarketing.com.co/assets/images/v3/logo-vision-marketing-ohla-blanco.png"
             alt="Logo Visión y Marketing" class="h-10">
        <h1 class="text-2xl font-bold tracking-wide">Portal de Documentos de Clientes</h1>
      </div>
    </div>
  </header>

  <!-- CONTENIDO -->
  <main class="flex-grow max-w-6xl mx-auto px-6 py-10">
    <h2 id="titulo" class="text-xl font-semibold mb-6 border-b-2 border-red-600 pb-2">Explorador</h2>
    <div id="loader" class="loader"></div>
    <div id="contenedor" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden"></div>
  </main>

  <!-- FOOTER -->
  <footer class="brand-red text-white text-center py-5 mt-auto">
    <p class="text-sm">© 2025 Visión y Marketing · Todos los derechos reservados</p>
    <p class="text-xs opacity-90 mt-1">
      Para contacto o soporte:
      <a href="mailto:jhon.piza@visionymarketing.com.co" class="underline">jhon.piza@visionymarketing.com.co</a>
    </p>
  </footer>

  <!-- SCRIPT -->
  <script>
    const usuario = "JhonPizaVision";
    const repositorio = "VisionyMarketing";
    const baseURL = `https://api.github.com/repos/${usuario}/${repositorio}/git/trees/main?recursive=1`;

    // Obtener ruta actual desde URL (por ejemplo: ?ruta=DocumentosClientes/NestlePurina/InformeGestion)
    const params = new URLSearchParams(window.location.search);
    const rutaActual = params.get("ruta") || "DocumentosClientes";

    async function cargarContenido() {
      const contenedor = document.getElementById("contenedor");
      const titulo = document.getElementById("titulo");
      const loader = document.getElementById("loader");

      try {
        // Mostrar loader y ocultar contenedor
        loader.classList.remove("hidden");
        contenedor.classList.add("hidden");

        const resp = await fetch(baseURL);
        const data = await resp.json();
        if (!data.tree) throw new Error("No se encontró contenido");

        // Filtrar elementos dentro de la ruta actual
        const nivelActual = data.tree.filter(item => item.path.startsWith(rutaActual + "/"));

        // Extraer solo el siguiente nivel (carpetas o archivos directamente dentro)
        const items = new Map();
        
        nivelActual.forEach(item => {
          const relativo = item.path.replace(rutaActual + "/", "");
          const partes = relativo.split("/");
          
          // Si solo hay una parte y no está vacío, es un archivo directo
          if (partes.length === 1 && relativo !== "") {
            items.set(item.path, { 
              tipo: "archivo", 
              nombre: partes[0], 
              path: item.path 
            });
          } 
          // Si hay más de una parte, es una carpeta o archivo dentro de subcarpeta
          else if (partes.length > 1) {
            const carpeta = partes[0];
            // Solo agregar la carpeta si no existe ya
            if (!items.has(carpeta)) {
              items.set(carpeta, { 
                tipo: "carpeta", 
                nombre: carpeta, 
                path: `${rutaActual}/${carpeta}` 
              });
            }
          }
        });

        // Mostrar título
        titulo.textContent = rutaActual === "DocumentosClientes"
          ? "Clientes"
          : `Contenido de ${rutaActual.split("/").slice(1).join(" / ")}`;

        contenedor.innerHTML = "";

        if (items.size === 0) {
          contenedor.innerHTML = "<p class='col-span-full text-center text-gray-600'>No hay contenido disponible.</p>";
        } else {
          // Convertir Map a Array y ordenar: carpetas primero, luego archivos
          const itemsOrdenados = Array.from(items.values()).sort((a, b) => {
            if (a.tipo === b.tipo) return a.nombre.localeCompare(b.nombre);
            return a.tipo === "carpeta" ? -1 : 1;
          });

          itemsOrdenados.forEach(item => {
            if (item.tipo === "carpeta") {
              const card = document.createElement("a");
              card.href = `?ruta=${encodeURIComponent(item.path)}`;
              card.className = "bg-white rounded-xl shadow border border-gray-200 p-5 flex flex-col items-center text-center brand-hover cursor-pointer";
              card.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-600 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 7l3-3h15a2 2 0 012 2v12a2 2 0 01-2 2H3V7z" />
                </svg>
                <h3 class="text-md font-semibold text-gray-800">${item.nombre}</h3>
                <p class="text-sm text-gray-500 mt-1">Abrir carpeta</p>
              `;
              contenedor.appendChild(card);
            } else {
              // Usar GitHub RAW para archivos en lugar de GitHub Pages
              const urlPublica = `https://raw.githubusercontent.com/${usuario}/${repositorio}/main/${encodeURIComponent(item.path).replace(/%2F/g, "/")}`;
              const extension = item.nombre.split(".").pop().toLowerCase();

              // Iconos mejorados para diferentes tipos de archivo
              let icono = '';
              if (extension === "pdf") {
                icono = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>`;
              } else if (["xlsx","xls"].includes(extension)) {
                icono = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>`;
              } else if (["png","jpg","jpeg","gif","bmp","svg"].includes(extension)) {
                icono = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-500 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>`;
              } else if (["doc","docx"].includes(extension)) {
                icono = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>`;
              } else {
                icono = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-500 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>`;
              }

              const card = document.createElement("a");
              card.href = urlPublica;
              card.target = "_blank";
              card.className = "bg-white rounded-xl shadow border border-gray-200 p-5 flex flex-col text-center brand-hover cursor-pointer";
              card.innerHTML = `
                ${icono}
                <p class="text-sm font-medium text-gray-700 truncate">${item.nombre}</p>
                <span class="text-xs text-gray-500 mt-1">${extension.toUpperCase()}</span>
              `;
              contenedor.appendChild(card);
            }
          });
        }

        // Botón volver si no estamos en el nivel raíz
        if (rutaActual !== "DocumentosClientes") {
          const partes = rutaActual.split("/");
          partes.pop();
          const rutaPadre = partes.join("/");
          const volver = document.createElement("a");
          volver.href = `?ruta=${encodeURIComponent(rutaPadre || "DocumentosClientes")}`;
          volver.className = "block mt-8 text-center text-red-600 font-semibold underline cursor-pointer";
          volver.textContent = "← Volver";
          contenedor.after(volver);
        }

      } catch (err) {
        console.error(err);
        contenedor.innerHTML = "<p class='text-center text-red-600'>Error al cargar contenido desde GitHub.</p>";
      } finally {
        // Ocultar loader y mostrar contenedor
        loader.classList.add("hidden");
        contenedor.classList.remove("hidden");
      }
    }

    cargarContenido();
  </script>

</body>
</html>